
@if (project(); as p) {
  <div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <!-- Project Completion Summary -->
    @if (p.status === 'Completed') {
      <div class="bg-green-50 border-b-2 border-green-200 p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
             <svg class="h-12 w-12 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
          </div>
          <div class="ml-4">
            <h2 class="text-xl font-bold text-green-800">Project Completed!</h2>
            <p class="text-sm text-green-700 mt-1">
              This project was successfully completed on <span class="font-semibold">{{ completionDate() ?? 'N/A' }}</span>.
            </p>
          </div>
        </div>
      </div>
    }

    <!-- Common Project Header -->
    <div class="p-6 border-b border-gray-200">
      <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
        <div>
          <h1 class="text-2xl font-bold tracking-tight text-gray-900">{{ p.name }}</h1>
          <p class="mt-1 text-sm text-gray-500">{{ p.description }}</p>
           @if (p.assignedFieldAdminUsername) {
            <p class="mt-2 text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1 inline-block">
              Field Admin: <span class="font-semibold">{{p.assignedFieldAdminUsername}}</span>
            </p>
           }
        </div>
        <div class="flex-shrink-0 flex items-center gap-x-4">
           @if(currentUser()?.role !== 'Admin Lapangan') {
            <button (click)="exportToCsv()" type="button" class="relative inline-flex items-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50" [disabled]="p.updates.length === 0">
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-600">
                  <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
                  <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
                </svg>
              Export to Excel
            </button>
          }
          <span [class]="'text-sm font-semibold px-4 py-2 rounded-full ' + getStatusColor(p.status)">
            {{ p.status }}
          </span>
        </div>
      </div>
      
      <div class="mt-6">
        <div class="flex justify-between items-center mb-1">
          <span class="text-sm font-medium text-gray-700">Overall Progress</span>
          <span class="text-sm font-medium text-gray-700">{{ p.progress }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4">
          <div class="bg-blue-600 h-4 rounded-full flex items-center justify-center text-white text-xs" [style.width.%]="p.progress">{{ p.progress > 10 ? p.progress+'%' : '' }}</div>
        </div>
      </div>
      
      <div class="mt-6 border-t border-gray-200 pt-6">
        <dl class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-6 text-sm">
          <div class="sm:col-span-1">
            <dt class="text-gray-500">Start Date</dt>
            <dd class="mt-1 font-medium text-gray-900">{{ p.startDate }}</dd>
          </div>
          <div class="sm:col-span-1">
            <dt class="text-gray-500">End Date</dt>
            <dd class="mt-1 font-medium text-gray-900">{{ p.endDate }}</dd>
          </div>
          <div class="sm:col-span-1">
            <dt class="text-gray-500">Work Volume</dt>
            <dd class="mt-1 font-medium text-gray-900">{{ p.workVolume }}</dd>
          </div>
          <div class="sm:col-span-1">
            <dt class="text-gray-500">Total Cost</dt>
            <dd class="mt-1 font-medium text-gray-900">{{ p.totalCost | number:'1.2-2' }}</dd>
          </div>
        </dl>
      </div>

      <!-- Office Admin: Status Control Panel -->
      @if (currentUser()?.role === 'Admin Kantor') {
        <div class="mt-6 border-t border-gray-200 pt-6">
          <h3 class="text-sm font-medium text-gray-900">Manage Project Status</h3>
          <div class="mt-4 flex items-center gap-x-2">
            @for (status of projectStatuses; track status) {
              <button
                (click)="changeProjectStatus(status)"
                [class]="'px-3 py-1 text-sm font-semibold rounded-full ' + (p.status === status ? getStatusColor(status) + ' ring-2 ring-offset-1 ' + (status === 'Completed' ? 'ring-green-500' : 'ring-blue-500') : 'text-gray-700 bg-gray-100 hover:bg-gray-200')"
                >
                {{ status }}
              </button>
            }
          </div>
        </div>
      }

    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 p-6">
      <!-- Left Column: Progress Reports -->
      <div class="lg:col-span-2">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Progress Reports</h2>
        @if (p.updates.length > 0) {
            @for(month of monthlyReports().keys(); track month) {
              <div class="mb-8">
                <h3 class="text-md font-semibold text-gray-700 pb-2 border-b border-gray-200">{{ month }}</h3>
                <ul role="list" class="mt-4 space-y-6">
                  @for(update of monthlyReports().get(month); track update.id) {
                    <li class="flex gap-x-4">
                        <div class="relative last:after:hidden after:absolute after:top-7 after:bottom-0 after:w-px after:bg-gray-200 after:content-['']">
                        <div class="relative flex h-6 w-6 flex-none items-center justify-center bg-white">
                            @if (update.verified) {
                            <svg class="h-6 w-6 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" />
                            </svg>
                            } @else {
                            <div class="h-1.5 w-1.5 rounded-full bg-gray-300 ring-1 ring-gray-400"></div>
                            }
                        </div>
                      </div>
                      <div class="flex-grow bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between">
                            <p class="flex-grow text-sm font-semibold text-gray-900">{{ update.summary }}</p>
                            <p class="text-sm text-gray-500 ml-4 flex-shrink-0">{{ update.date }}</p>
                        </div>
                        <p class="mt-2 text-sm text-gray-700">{{update.workDescription}}</p>
                        @if (update.photo) {
                           <div class="mt-3">
                              <img [src]="update.photo" alt="Progress photo" class="max-h-60 w-auto rounded-md shadow-sm border"/>
                           </div>
                        }
                        <div class="mt-3 flex items-center justify-between">
                          <p class="text-xs text-gray-500">by {{ update.author }} (+{{update.progressMade}}% progress)</p>
                          @if(currentUser()?.role === 'Admin Kantor' && !update.verified) {
                              <button (click)="verifyUpdate(update.id)" class="text-xs text-blue-600 hover:text-blue-800 font-semibold">Verify</button>
                          }
                        </div>
                      </div>
                    </li>
                  }
                </ul>
              </div>
            }
        } @else {
          <div class="text-center py-10 px-6 bg-gray-50 rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mx-auto h-12 w-12 text-gray-400">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
            </svg>
            <h3 class="mt-2 text-sm font-semibold text-gray-900">No Updates Yet</h3>
            <p class="mt-1 text-sm text-gray-500">No progress updates have been submitted yet.</p>
          </div>
        }
      </div>

      <!-- Right Column: Form -->
      <div class="lg:col-span-1">
        <div class="bg-gray-50 p-6 rounded-lg sticky top-6">
          
          @if (p.status !== 'Completed') {
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Submit Daily Report</h2>
             @if (!canHandleProject() && currentUser()?.role === 'Admin Lapangan') {
                <div class="text-center p-4 bg-yellow-100 text-yellow-800 rounded-md text-sm">
                    You are not assigned to this project and cannot submit reports.
                </div>
             }
            <form [formGroup]="dailyReportForm" (ngSubmit)="onDailyReportSubmit()">
             <fieldset [disabled]="!canHandleProject()" class="space-y-4">
                <div>
                  <label for="daily-summary" class="block text-sm font-medium text-gray-700">Update Summary</label>
                  <input id="daily-summary" formControlName="summary" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., Pengecoran Selesai" style="color-scheme: light;"/>
                </div>
                <div>
                  <label for="workDescription" class="block text-sm font-medium text-gray-700">Work Description</label>
                  <textarea id="workDescription" formControlName="workDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Describe the work done today..." style="color-scheme: light;"></textarea>
                </div>

                <!-- Photo Upload and Camera -->
                <div>
                  <label class="block text-sm font-medium text-gray-700">Photo Evidence</label>
                  <div class="mt-2">
                    @if (capturedImage()) {
                      <div class="relative">
                         <img [src]="capturedImage()" alt="Captured photo" class="w-full h-auto rounded-md border"/>
                         <button (click)="clearPhoto()" type="button" class="absolute top-1 right-1 bg-white/70 rounded-full p-1 text-gray-700 hover:text-black">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" /></svg>
                         </button>
                      </div>
                    } @else if(isCameraOpen()) {
                        <div>
                            <video #videoPlayer autoplay playsinline class="w-full rounded-md border"></video>
                            <div class="mt-2 grid grid-cols-2 gap-2">
                                <button (click)="capturePhoto()" type="button" class="w-full inline-flex items-center justify-center gap-x-1.5 rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                                   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M2 5.5a3.5 3.5 0 0 1 3.5-3.5h9A3.5 3.5 0 0 1 18 5.5v9a3.5 3.5 0 0 1-3.5 3.5h-9A3.5 3.5 0 0 1 2 14.5v-9ZM4 5.5a1.5 1.5 0 0 1 1.5-1.5h9A1.5 1.5 0 0 1 16 5.5v9a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 4 14.5v-9Z" /><path d="M10 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6ZM10 13.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3Z" /></svg>
                                   Capture
                                </button>
                                <button (click)="closeCamera()" type="button" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                            </div>
                        </div>
                    } @else {
                        <div class="grid grid-cols-2 gap-2">
                             <button (click)="openCamera()" type="button" class="w-full inline-flex items-center justify-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-500"><path d="M6 3a3 3 0 0 0-3 3v8a3 3 0 0 0 3 3h8a3 3 0 0 0 3-3V6a3 3 0 0 0-3-3H6ZM10 14a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z" /><path d="M10 11.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" /></svg>
                                Camera
                             </button>
                            <label for="photo-upload" class="w-full inline-flex items-center justify-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-500"><path d="M9.25 13.25a.75.75 0 0 0 1.5 0V4.636l2.955 3.129a.75.75 0 0 0 1.09-1.03l-4.25-4.5a.75.75 0 0 0-1.09 0l-4.25 4.5a.75.75 0 0 0 1.09 1.03L9.25 4.636v8.614Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>
                                Upload
                            </label>
                            <input type="file" id="photo-upload" (change)="onFileSelected($event)" accept="image/*" class="sr-only"/>
                        </div>
                    }
                  </div>
                </div>

                <div>
                  <label for="workVolumeUpdate" class="block text-sm font-medium text-gray-700">Updated Work Volume (Optional)</label>
                  <input type="text" id="workVolumeUpdate" formControlName="workVolume" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" [placeholder]="'Current: ' + p.workVolume" style="color-scheme: light;">
                </div>
                <div>
                  <label for="totalCostUpdate" class="block text-sm font-medium text-gray-700">Updated Total Cost (Optional)</label>
                  <input type="number" id="totalCostUpdate" formControlName="totalCost" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" [placeholder]="'Current: ' + p.totalCost" style="color-scheme: light;">
                </div>
                <div>
                  <label for="daily-progressMade" class="block text-sm font-medium text-gray-700">Progress Added (%)</label>
                  <input type="number" id="daily-progressMade" formControlName="progressMade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g. 5" style="color-scheme: light;">
                </div>
                <button type="submit" [disabled]="dailyReportForm.invalid || !canHandleProject()" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  Submit Report
                </button>
              </fieldset>
            </form>
          } @else {
            <div class="text-center p-4 bg-gray-100 rounded-md">
              <p class="text-sm font-medium text-gray-700">This project is complete. No further updates can be added.</p>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
} @else {
  <p class="text-center text-gray-500">Project not found or is loading...</p>
}